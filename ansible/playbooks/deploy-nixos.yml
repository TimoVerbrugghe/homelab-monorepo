---
- name: Install NixOS using Ansible
  hosts: nixos
  become: true
  gather_facts: false

  tasks:
    - name: Format the hard drive
      command: >
        sgdisk --zap-all /dev/sda &&
        sgdisk --new=1:0:+512M --typecode=1:ef00 /dev/sda &&
        sgdisk --new=2:0:0 --typecode=2:8300 /dev/sda &&
        sgdisk --new=3:0:+4G --typecode=3:8200 /dev/sda

    - name: Create filesystems
      command: >
        mkfs.vfat -F 32 /dev/sda1 &&
        mkfs.btrfs /dev/sda2 &&
        mkswap /dev/sda3

    - name: Mount partitions
      command: >
        mount /dev/sda2 /mnt &&
        mkdir /mnt/boot &&
        mount /dev/sda1 /mnt/boot &&
        swapon /dev/sda3

    - name: Generate NixOS hardware configuration
      command: nixos-generate-config --root /mnt
      register: config_generation

    - name: Upload hardware configuration to GitHub
      github_repo: 
        repo: "TimoVerbrugghe/homelab-monorepo/nixos/machines/nixos2"
        token: "your_github_token"
        path: "/mnt/etc/nixos/hardware-configuration.nix"
        content: "{{ config_generation.stdout_lines | join('\n') }}"

    - name: Run NixOS installation
      command: nixos-install --flake "github:your_github_username/nixos-config#your_branch"

    - name: Reboot machine
      command: reboot