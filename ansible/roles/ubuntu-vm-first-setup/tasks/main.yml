- name: Do Apt update & upgrade
  ansible.builtin.include_tasks: apt-dist-upgrade.yml

- name: Install docker
  ansible.builtin.include_tasks: install-docker.yml

- name: Install qemu-guest-agent
  ansible.builtin.include_tasks: install-qemu-guest-agent.yml
  
- name: Enable watchdog
  ansible.builtin.include_tasks: enable-watchdog.yml

# Set up a macvlan bridge using netplan on ubuntu. 
# This is necessary if you have docker containers with macvlan configured that you want to connect to from the docker host (f.e. a DNS container that uses macvlan to have a separate IP to expose ports 80, 53, 443, etc...).

- name: Configure macvlan
  ansible.builtin.include_tasks: macvlan-config.yml
  when: macvlan_routes

# Increase the UDP buffer size in order to have more stable QUIC connections, necessary for the cloudflare tunnel
# More information available here: https://github.com/quic-go/quic-go/wiki/UDP-Buffer-Sizes

- name: Increase UDP buffer size
  ansible.builtin.include_tasks: increase-udp-buffer-size.yml

- name: Install intel driver (if VM has enable_gpu set to true)
  ansible.builtin.include_tasks: install-intel-gpu-driver.yml
  when: enable_gpu

- name: Enable swap
  ansible.builtin.include_tasks: enable-swap.yml

- name: Reboot (to make sure all settings are applied)
  ansible.builtin.reboot: