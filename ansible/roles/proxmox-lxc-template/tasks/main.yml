- name: Pause to remind to set a DHCP reservation for the mac address
  ansible.builtin.pause:
    prompt: "Press enter if you have set a DHCP reservation (in Unifi f.e.) based on the MAC address (or if it's not needed)"

- name: Download Github Keys
  ansible.builtin.set_fact: 
    sshkeys: "{{ lookup('ansible.builtin.url', 'https://github.com/{{ github_username }}.keys', split_lines=false) }}"

- name: Update PVE template list
  command: pveam update

- name: Download LXC template
  command: pveam download local "{{ lxc_ostemplate_name }}"

- name: Create new LXC container
  community.general.proxmox:
    node: "{{ proxmox_node | default('proxmox') }}"
    api_user: "{{ proxmox_api_user }}"
    api_token_id: "{{ proxmox_api_tokenid }}"
    api_token_secret: "{{ proxmox_api_tokensecret }}"
    api_host: "{{ proxmox_api_host }}"

    vmid: "{{ lxc_template_id | default(9999) }}"
    password: "{{ lxc_template_password | default('templatepassword') }}"
    hostname: "{{ lxc_template_name | default('ubuntu-lxc') }}"
    ostemplate: "local:vztmpl/{{ lxc_ostemplate_name }}"
    pubkey: "{{ sshkeys }}"
    storage: "{{ lxc_template_storage | default('local-zfs') }}"
    disk: "{{ lxc_template_storage | default('local-zfs') }}:{{ lxc_template_disksize }}"
    unprivileged: false
    onboot: true
    memory: "{{ lxc_template_memory | default(2048) }}"
    timezone: "host"
    netif: '{"net0":"name=eth0,ip=dhcp,ip6=dhcp,bridge={{ lxc_template_bridge | default("vmbr0") }}"}'
  register: lxc_container_info

- name: Pause to remind to change feature set before starting container
  ansible.builtin.pause:
    prompt: "CONTAINER CREATED - Press enter if you have set the necessary features on the container through the Web UI (f.e. NFS/CIFS support - has to be done manually, not possible using the proxmox api)"

- name: Sleep for 5 seconds to let container be created
  ansible.builtin.wait_for:
    timeout: 5

- name: Create template
  ansible.builtin.command:
    cmd: pct set "{{ lxc_template_id | default(9999) }}" --template true
  changed_when: false