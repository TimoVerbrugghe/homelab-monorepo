version: "3.8"

services:
  scrypted:
    container_name: scrypted
    restart: unless-stopped
    network_mode: host
    image: koush/scrypted
    # hardware accelerated video decoding
    devices:
      - /dev/dri:/dev/dri
    volumes:
      - scrypted:/server/volume
    labels:
      - traefik.enable=false
    security_opt:
      - apparmor:unconfined

  jellyfin:
    container_name: jellyfin
    image: jellyfin/jellyfin
    restart: unless-stopped
    environment:
      - TZ=Europe/Brussels
    volumes:
      - jellyfin:/config
      - /tmp:/cache
      - movies:/movies
      - tvshows:/tv
      - /dev/shm:/dev/shm
    devices:
      - /dev/dri:/dev/dri
    ports:
      - 8096:8096
    security_opt:
      - apparmor:unconfined

  plex:
    container_name: plex
    image: plexinc/pms-docker
    restart: unless-stopped
    environment:
      - TZ=Europe/Brussels
      - PLEX_CLAIM=${PLEX_CLAIM_TOKEN}
    ports:
      - 32400:32400/tcp
      - 32410:32410/udp
      - 32412:32412/udp
      - 32413:32413/udp
      - 32414:32414/udp
    volumes:
      - movies:/movies:rw
      - tvshows:/tv:rw
      - /tmp:/transcode:rw
      - plex:/config:rw
      - /dev/shm:/dev/shm
    devices:
      - /dev/dri:/dev/dri
    security_opt:
      - apparmor:unconfined

volumes:
  scrypted:
  plex:
  jellyfin:
  movies:
    driver: local
    driver_opts:
      type: "nfs"
      o: "addr=nfs.timo.local,nolock,rw,vers=4.2,relatime,sec=sys,hard"
      device: ":/mnt/user/movies"
  tvshows:
    driver: local
    driver_opts:
      type: "nfs"
      o: "addr=nfs.timo.local,nolock,rw,vers=4.2,relatime,sec=sys,hard"
      device: ":/mnt/user/tvshows"