apiVersion: apps/v1
kind: Deployment
metadata:
  name: changedetection
  namespace: utilities
spec:
  replicas: 1
  selector:
    matchLabels:
      app: changedetection
  template:
    metadata:
      labels:
        app: changedetection
    spec:
      nodeSelector:
        kubernetes.io/hostname: yumi
      containers:
      - name: changedetection
        image: ghcr.io/dgtlmoon/changedetection.io:latest
        imagePullPolicy: IfNotPresent
        env:
        - name: BASE_URL
          value: "https://changedetection.timo.be"
        - name: PLAYWRIGHT_DRIVER_URL
          value: "ws://playwright-chrome.changedetection.svc.cluster.local:3000/?stealth=1&--disable-web-security=true"
        resources:
          requests:
            cpu: "100m"
            memory: "128Mi"
          limits:
            cpu: "500m"
            memory: "512Mi"
        
        startupProbe:
          httpGet:
            path: /
            port: 5000
          initialDelaySeconds: 10
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 30
          successThreshold: 1
        
        readinessProbe:
          httpGet:
            path: /
            port: 5000
          initialDelaySeconds: 5
          periodSeconds: 10
          timeoutSeconds: 3
          failureThreshold: 3
          successThreshold: 1
        
        livenessProbe:
          httpGet:
            path: /
            port: 5000
          initialDelaySeconds: 30
          periodSeconds: 30
          timeoutSeconds: 5
          failureThreshold: 3
          successThreshold: 1
        
        volumeMounts:
          - name: changedetection-data
            mountPath: /datastore
      volumes:
        - name: changedetection-data
          hostPath:
            path: /var/mnt/changedetection
            type: Directory

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: playwright-chrome
  namespace: utilities
spec:
  replicas: 1
  selector:
    matchLabels:
      app: playwright-chrome
  template:
    metadata:
      labels:
        app: playwright-chrome
    spec:
      containers:
      - name: playwright-chrome
        image: browserless/chrome:latest
        imagePullPolicy: IfNotPresent
        env:
        - name: SCREEN_WIDTH
          value: "1920"
        - name: SCREEN_HEIGHT
          value: "1024"
        - name: SCREEN_DEPTH
          value: "16"
        - name: ENABLE_DEBUGGER
          value: "false"
        - name: PREBOOT_CHROME
          value: "true"
        - name: CONNECTION_TIMEOUT
          value: "300000"
        - name: MAX_CONCURRENT_SESSIONS
          value: "10"
        - name: CHROME_REFRESH_TIME
          value: "600000"
        - name: DEFAULT_BLOCK_ADS
          value: "true"
        - name: DEFAULT_STEALTH
          value: "true"
        - name: DEFAULT_IGNORE_HTTPS_ERRORS
          value: "true"
        resources:
          requests:
            memory: "512Mi"
            cpu: "500m"
          limits:
            memory: "2Gi"
            cpu: "2000m"
        
        startupProbe:
          httpGet:
            path: /
            port: 3000
          initialDelaySeconds: 10
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 30
          successThreshold: 1
        
        readinessProbe:
          httpGet:
            path: /
            port: 3000
          initialDelaySeconds: 5
          periodSeconds: 10
          timeoutSeconds: 3
          failureThreshold: 3
          successThreshold: 1
        
        livenessProbe:
          httpGet:
            path: /
            port: 3000
          initialDelaySeconds: 30
          periodSeconds: 30
          timeoutSeconds: 5
          failureThreshold: 3
          successThreshold: 1