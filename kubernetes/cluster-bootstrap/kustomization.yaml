# Apply this kustomization with `kubectl apply -k .` from the directory containing this file to bootstrap cluster with several services 

# Reference to all kustomize helmCharts fields: https://kubectl.docs.kubernetes.io/references/kustomize/builtins/#_helmchartinflationgenerator_
# Examples used as reference: https://medium.com/@tharukam/generate-kubernetes-manifests-with-helm-charts-using-kustomize-2f82ab5c5f11
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  # Kube-VIP installation for Virtual IP management
  - https://kube-vip.io/manifests/rbac.yaml
  - https://raw.githubusercontent.com/kube-vip/kube-vip-cloud-provider/main/manifest/kube-vip-cloud-controller.yaml
  - kube-vip/kube-vip-configmap.yaml
  - kube-vip/kube-vip.yaml

  # Traefik, tailscale, reflector resources complementary to Helm installation
  - traefik/traefik-namespace.yaml
  - traefik/traefik-service.yaml
  - tailscale/tailscale-namespace.yaml
  - cert-manager/cert-manager-namespace.yaml
  - reflector/reflector-namespace.yaml

  # Portainer agent installation
  - https://downloads.portainer.io/ce2-27/portainer-agent-k8s-lb.yaml

# Patch to enable keel autoupdating on portainer-agent
patches:
  - target:
      kind: Deployment
      name: portainer-agent
    path: portainer-agent-patch.yaml

helmCharts:
  # Reflector to automatically copy secrets between namespaces
  - name: reflector
    repo: https://emberstack.github.io/helm-charts
    namespace: reflector
    includeCRDs: true
    valuesFile: reflector/reflector-values.yaml

  # Cert-manager for certificate management (Let's Encrypt)
  - name: cert-manager
    repo: https://charts.jetstack.io
    namespace: cert-manager
    includeCRDs: true
    valuesFile: cert-manager-values.yaml

  - name: traefik
    repo: https://traefik.github.io/charts
    namespace: traefik
    includeCRDs: true
    valuesFile: traefik/traefik-values.yaml
  
  - name: tailscale-operator
    repo: https://tailscale.github.io/tailscale-k8s
    namespace: tailscale
    includeCRDs: true
    valuesFile: tailscale/tailscale-values.yaml