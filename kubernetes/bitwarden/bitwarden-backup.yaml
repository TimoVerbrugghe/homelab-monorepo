apiVersion: batch/v1
kind: CronJob
metadata:
  name: bitwarden-backup
  namespace: bitwarden
spec:
  schedule: "0 2 * * *" # Runs daily at 2 AM
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: OnFailure
          containers:
            - name: backup
              image: alpine:latest
              command:
                - /bin/sh
                - -c
                - |
                  set -e
                  BACKUP_NAME="bitwarden-backup-$(date +%Y%m%d%H%M%S).tar.gz"
                  tar czf "/nfs/${BACKUP_NAME}" -C /backup .
                  cd /nfs
                  ls -1t bitwarden-backup-*.tar.gz | tail -n +4 | xargs -r rm --
              volumeMounts:
                - name: bitwarden-data
                  mountPath: /backup
                - name: nfs-backup
                  mountPath: /nfs
          volumes:
            - name: bitwarden-data
              hostPath:
                path: /var/mnt/bitwarden
                type: Directory
            - name: nfs-backup
              nfs:
                server: nfs.local.timo.be
                path: /mnt/FranzHopper/appdata/bitwarden