---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: iscsi-test
  namespace: iscsi-test
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: iscsi-test
  template:
    metadata:
      labels:
        app: iscsi-test
    spec:
      initContainers:
      # Validate storage is accessible before starting
      - name: storage-validator
        image: alpine:latest
        imagePullPolicy: IfNotPresent
        command: ['sh', '-c']
        args:
        - |
          set -e
          echo "Validating iSCSI storage accessibility..."
          
          # Test write access
          if ! echo "healthcheck" > /data/.healthcheck 2>&1; then
            echo "ERROR: Cannot write to /data - storage not accessible"
            exit 1
          fi
          
          # Test read access
          if ! cat /data/.healthcheck > /dev/null 2>&1; then
            echo "ERROR: Cannot read from /data - storage not healthy"
            exit 1
          fi
          
          rm -f /data/.healthcheck
          echo "Storage validation passed"
        volumeMounts:
        - name: iscsi-storage
          mountPath: /data
      
      containers:
      - name: test-container
        image: alpine:latest
        command:
        - /bin/sh
        - -c
        - |
          #!/bin/sh
          set -e
          
          echo "iSCSI Test Container Starting..."
          echo "Mounted storage at /data"
          
          # Create initial test file
          echo "Container started at $(date)" > /data/startup.log
          
          # Keep container running and periodically write to storage
          while true; do
            echo "$(date): Writing test data..."
            echo "$(date): Storage test" >> /data/test.log
            sleep 1200
          done
        
        livenessProbe:
          exec:
            command:
            - timeout
            - "2"
            - sh
            - -c
            - touch /data/.liveness_check && rm -f /data/.liveness_check
          initialDelaySeconds: 10
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
          successThreshold: 1
        
        volumeMounts:
        - name: iscsi-storage
          mountPath: /data
        
        resources:
          requests:
            cpu: 10m
            memory: 32Mi
          limits:
            cpu: 100m
            memory: 128Mi
      
      volumes:
      - name: iscsi-storage
        persistentVolumeClaim:
          claimName: iscsi-test-pvc
