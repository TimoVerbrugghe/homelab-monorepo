---
# Standalone pod watcher that monitors the iscsi-test pod from outside
# This runs independently so it can delete pods even when init containers fail
apiVersion: apps/v1
kind: Deployment
metadata:
  name: iscsi-test-external-watcher
  namespace: iscsi-test
spec:
  replicas: 1
  selector:
    matchLabels:
      app: iscsi-test-external-watcher
  template:
    metadata:
      labels:
        app: iscsi-test-external-watcher
    spec:
      serviceAccountName: iscsi-test-watcher
      containers:
      - name: watcher
        image: bash:latest
        command:
        - /usr/local/bin/bash
        - -c
        - |
          #!/bin/sh
          set -e
          
          # Install kubectl and jq
          apk add --no-cache curl jq
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          mv kubectl /usr/local/bin/
          
          echo "=========================================="
          echo "iSCSI Test External Pod Watcher"
          echo "=========================================="
          echo "Monitoring: iscsi-test deployment"
          echo "Triggers:"
          echo "  - Init container CrashLoopBackOff"
          echo "  - Main container CrashLoopBackOff"
          echo "  - Test container restart count >= 2"
          echo ""
          
          COOLDOWN_SECONDS=120  # 2 minutes cooldown after deletion
          LAST_DELETE_TIME=0
          RESTART_THRESHOLD=2
          
          while true; do
            CURRENT_TIME=$(date +%s)
            TIME_SINCE_DELETE=$((CURRENT_TIME - LAST_DELETE_TIME))
            
            # Get all pods for the iscsi-test deployment
            PODS=$(kubectl get pods -n iscsi-test -l app=iscsi-test -o json 2>/dev/null || echo '{"items":[]}')
            POD_COUNT=$(echo "$PODS" | jq -r '.items | length' | tr -d '\n\r' | xargs)
            
            if [[ "$POD_COUNT" == "" ]] || [[ "$POD_COUNT" -eq 0 ]]; then
              echo "$(date '+%Y-%m-%d %H:%M:%S') - âš ï¸  No iscsi-test pods found"
              sleep 30
              continue
            fi
            
            # Process each pod
            i=0
            while [[ $i -lt $POD_COUNT ]]; do
              POD_JSON=$(echo "$PODS" | jq -r ".items[$i]")
              POD_NAME=$(echo "$POD_JSON" | jq -r '.metadata.name')
              
              if [ -z "$POD_NAME" ] || [ "$POD_NAME" = "null" ]; then
                continue
              fi
              
              # Check init container status
              INIT_STATUS=$(echo "$POD_JSON" | jq -r '.status.initContainerStatuses[]? | select(.name=="storage-validator") | .state | keys[0]' 2>/dev/null || echo "")
              INIT_REASON=$(echo "$POD_JSON" | jq -r '.status.initContainerStatuses[]? | select(.name=="storage-validator") | .state.waiting.reason' 2>/dev/null || echo "")
              INIT_RESTARTS=$(echo "$POD_JSON" | jq -r '.status.initContainerStatuses[]? | select(.name=="storage-validator") | .restartCount' 2>/dev/null || echo "0")
              
              # Check main container status
              TEST_CONTAINER_STATUS=$(echo "$POD_JSON" | jq -r '.status.containerStatuses[]? | select(.name=="test-container") | .state | keys[0]' 2>/dev/null || echo "")
              TEST_CONTAINER_REASON=$(echo "$POD_JSON" | jq -r '.status.containerStatuses[]? | select(.name=="test-container") | .state.waiting.reason' 2>/dev/null || echo "")
              TEST_CONTAINER_RESTARTS=$(echo "$POD_JSON" | jq -r '.status.containerStatuses[]? | select(.name=="test-container") | .restartCount' 2>/dev/null || echo "0")
              
              SHOULD_DELETE=false
              DELETE_REASON=""
              
              # Check for init container in CrashLoopBackOff
              if [ "$INIT_REASON" = "CrashLoopBackOff" ]; then
                SHOULD_DELETE=true
                DELETE_REASON="Init container in CrashLoopBackOff (restarts: $INIT_RESTARTS)"
              
              # Check for main container in CrashLoopBackOff
              elif [ "$TEST_CONTAINER_REASON" = "CrashLoopBackOff" ]; then
                SHOULD_DELETE=true
                DELETE_REASON="Test container in CrashLoopBackOff (restarts: $TEST_CONTAINER_RESTARTS)"
              
              # Check for high restart count on test container
              elif [ "$TEST_CONTAINER_RESTARTS" -ge "$RESTART_THRESHOLD" ] && [ "$TEST_CONTAINER_STATUS" != "running" ]; then
                SHOULD_DELETE=true
                DELETE_REASON="Test container high restart count: $TEST_CONTAINER_RESTARTS"
              fi
              
              if [ "$SHOULD_DELETE" = true ]; then
                if [ $TIME_SINCE_DELETE -lt $COOLDOWN_SECONDS ]; then
                  REMAINING=$((COOLDOWN_SECONDS - TIME_SINCE_DELETE))
                  echo "$(date '+%Y-%m-%d %H:%M:%S') - â³ Pod $POD_NAME needs deletion ($DELETE_REASON), but cooldown active (${REMAINING}s remaining)"
                else
                  echo "$(date '+%Y-%m-%d %H:%M:%S') - ðŸ”´ Deleting pod $POD_NAME! Reason: $DELETE_REASON"
                  kubectl delete pod -n iscsi-test "$POD_NAME" --grace-period=60 2>&1
                  LAST_DELETE_TIME=$CURRENT_TIME
                  echo "$(date '+%Y-%m-%d %H:%M:%S') - âœ… Pod deletion initiated. Waiting for cooldown..."
                fi
              else
                STATUS_MSG="âœ… Pod $POD_NAME healthy"
                if [ "$INIT_STATUS" = "terminated" ]; then
                  STATUS_MSG="$STATUS_MSG | Init: completed"
                elif [ "$INIT_STATUS" = "running" ]; then
                  STATUS_MSG="$STATUS_MSG | Init: running"
                fi
                if [ "$TEST_CONTAINER_STATUS" = "running" ]; then
                  STATUS_MSG="$STATUS_MSG | Test: running (restarts: $TEST_CONTAINER_RESTARTS)"
                elif [ "$TEST_CONTAINER_STATUS" = "waiting" ] && [ "$TEST_CONTAINER_REASON" != "CrashLoopBackOff" ]; then
                  STATUS_MSG="$STATUS_MSG | Test: waiting ($TEST_CONTAINER_REASON, restarts: $TEST_CONTAINER_RESTARTS)"
                fi
                echo "$(date '+%Y-%m-%d %H:%M:%S') - $STATUS_MSG"
              fi
              
              i=$((i + 1))
            done
            
            sleep 30
          done
        
        resources:
          requests:
            cpu: 10m
            memory: 64Mi
          limits:
            cpu: 100m
            memory: 128Mi
