name: Update Talos Machines

on:
  workflow_dispatch:
    inputs:
      update_william:
        description: 'Update william'
        required: false
        type: boolean
        default: true
      update_manta:
        description: 'Update manta'
        required: false
        type: boolean
        default: true
      update_skidbladnir:
        description: 'Update skidbladnir'
        required: false
        type: boolean
        default: true
      update_yumi:
        description: 'Update yumi'
        required: false
        type: boolean
        default: true
      upgrade_kubernetes:
        description: 'Upgrade Kubernetes'
        required: false
        type: boolean
        default: true

jobs:
  update-talos:
    runs-on: ubuntu-latest
    
    env:
      ENDPOINT: 10.10.10.33
      WILLIAM: 10.10.10.30
      MANTA: 10.10.10.31
      SKIDBLADNIR: 10.10.10.32
      YUMI: 10.10.10.7
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get latest Talos release
        id: talos-version
        run: |
          LATEST_VERSION=$(curl -s https://api.github.com/repos/siderolabs/talos/releases/latest | jq -r '.tag_name')
          echo "version=$LATEST_VERSION" >> $GITHUB_OUTPUT
          echo "Latest Talos version: $LATEST_VERSION"

      - name: Extract schematic ID from base-config.yaml
        id: schematic
        run: |
          SCHEMATIC_ID=$(grep -oP 'factory\.talos\.dev/installer/\K[^:]+' kubernetes/talos/base-config.yaml)
          echo "id=$SCHEMATIC_ID" >> $GITHUB_OUTPUT
          echo "Schematic ID: $SCHEMATIC_ID"

      - name: Setup Talos config
        run: |
          mkdir -p ~/.talos
          echo "${{ secrets.TALOSCONFIG }}" > ~/.talos/config
          chmod 600 ~/.talos/config
        env:
          TALOSCONFIG: ~/.talos/config

      - name: Install talosctl
        run: |
          curl -sL https://talos.dev/install | sh
          talosctl version --client

      - name: Connect to Tailscale
        uses: tailscale/github-action@v2
        with:
          oauth-client-id: ${{ secrets.TAILSCALE_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TAILSCALE_OAUTH_CLIENT_SECRET }}
          tags: tag:github-cicd

      - name: Update Talos node skidbladnir
        if: ${{ inputs.update_skidbladnir }}
        env:
          IMAGE: factory.talos.dev/installer/${{ steps.schematic.outputs.id }}:${{ steps.talos-version.outputs.version }}
          TALOSCONFIG: ~/.talos/config
        run: |
          talosctl version -n $SKIDBLADNIR -e $ENDPOINT
          echo "Updating skidbladnir ($SKIDBLADNIR) to $IMAGE"
          talosctl upgrade --nodes $SKIDBLADNIR -e $ENDPOINT --image $IMAGE --wait || echo "Failed to update skidbladnir"
          sleep 30

      - name: Update Talos node manta
        if: ${{ inputs.update_manta }}
        env:
          IMAGE: factory.talos.dev/installer/${{ steps.schematic.outputs.id }}:${{ steps.talos-version.outputs.version }}
          TALOSCONFIG: ~/.talos/config
        run: |
          talosctl version -n $MANTA -e $ENDPOINT
          echo "Updating manta ($MANTA) to $IMAGE"
          talosctl upgrade --nodes $MANTA -e $ENDPOINT --image $IMAGE --wait || echo "Failed to update manta"
          sleep 30

      - name: Update Talos node william
        if: ${{ inputs.update_william }}
        env:
          IMAGE: factory.talos.dev/installer/${{ steps.schematic.outputs.id }}:${{ steps.talos-version.outputs.version }}
          TALOSCONFIG: ~/.talos/config
        run: |
          talosctl version -n $WILLIAM -e $ENDPOINT
          echo "Updating william ($WILLIAM) to $IMAGE"
          talosctl upgrade --nodes $WILLIAM -e $ENDPOINT --image $IMAGE --wait || echo "Failed to update william"
          sleep 30

      - name: Update Talos node yumi
        if: ${{ inputs.update_yumi }}
        env:
          IMAGE: factory.talos.dev/installer/${{ steps.schematic.outputs.id }}:${{ steps.talos-version.outputs.version }}
          TALOSCONFIG: ~/.talos/config
        run: |
          talosctl version -n $YUMI -e $ENDPOINT
          echo "Updating yumi ($YUMI) to $IMAGE"
          talosctl upgrade --nodes $YUMI -e $ENDPOINT --image $IMAGE --wait || echo "Failed to update yumi"

      - name: Upgrade Kubernetes
        if: ${{ inputs.upgrade_kubernetes }}
        env:
          TALOSCONFIG: ~/.talos/config
        run: |
          echo "Upgrading Kubernetes to latest version on Talos cluster"
          talosctl -e $ENDPOINT -n $WILLIAM upgrade-k8s

      - name: Summary
        run: |
          echo "âœ… Talos machines updated to ${{ steps.talos-version.outputs.version }}"
          echo "Image: factory.talos.dev/installer/${{ steps.schematic.outputs.id }}:${{ steps.talos-version.outputs.version }}"
